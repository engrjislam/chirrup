<html>
    <head>

        <!-- Example for using the /rooms/:id/chat/ route which connects to websocket on the server.-->
        <title>Socket-app</title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">

            // user_id = 1 is assumed
            var room_id;
            var nickname;
            var user_id = 1;


            // Save data to sessionStorage if available.
            //
            // Saved data survives page reloads and moving between pages.
            //
            // Data is deleted when browser is closed.
            if (typeof(Storage) !== 'undefined') {
                // Select some room_id from list of possible rooms. User would probably pick one manually.
                room_id = sessionStorage.getItem('room_id');
                room_id = undefined;  // used for resetting the room_id
                if (room_id === undefined){
                    // get_one_room returns a promise. .then clause is run after the ajax request has finished.
                    // If a promise or equivalent structure wasn't used room_id would be undefined
                    get_one_room()
                        .then(function(data){
                            room_id = data;
                            // save the room_id to sessionStorage
                            sessionStorage.setItem('room_id', parseInt(room_id));
                        });
                }

                // check if user nickname already gotten from api
                nickname = sessionStorage.getItem('nickname');
                nickname = undefined;
                if (nickname === undefined){
                    // if not get nickname and store it to sessionStorage
                    get_user_nickname(user_id)
                    .then(function(data){
                            nickname = data;
                            // save the nickname to sessionStorage
                            sessionStorage.setItem('nickname', nickname);
                        });
                }
            } else {
                // Sorry! No Web Storage support..
                console.log('Web storage can\'t be used');
                get_user_nickname(user_id)
                    .then(function(data){
                            nickname = data;
                        });
                get_one_room()
                        .then(function(data){
                            room_id = data;
                        });
            }

            // Socket related code. Room_id and user nickname are passed with the event.
            // Room_ids are used to separate messages accordingly to own rooms.
            // Nicknames are used to seperate messages.
            var socket;
            $(document).ready(function(){
                // Endpoint is the same for every message. Dynamic endpoints weren't supported.
                // Connects to route 'http://localhost:5000/rooms/1/chat/'
                //socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
                socket = io.connect('http://localhost:5000/chat/');
                console.log('http://localhost:5000/chat/');

                socket.on('connect', function() {
                    // socket.emit('foo', {key: value}) sends an foo event to connected route.
                    socket.emit('joined', {room_id: room_id, nickname: nickname});
                });
                socket.on('status', function(data) {
                    $('#chat').val($('#chat').val() + '<' + data.msg + '>\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
                socket.on('message', function(data) {
                    $('#chat').val($('#chat').val() + data.msg + '\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
                $('#text').keypress(function(e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        text = $('#text').val();
                        $('#text').val('');
                        socket.emit('text', {msg: text, room_id: room_id, nickname: nickname});
                    }
                });
            });
            function leave_room() {
                socket.emit('left', {room_id: room_id, nickname: nickname}, function() {
                    socket.disconnect();
                    // redirect somewhere else or close the chat window
                    // window.location.replace('some_other_file.html');

                });
            }

            function get_one_room(){
                return new Promise(function(resolve, reject){
                    $.get('http://localhost:5000/rooms/', function(data, status) {
                        console.log(data);
                        // example of getting a room from room_id
                        resolve(parseInt(data['rooms-all'][0]['room_id']));
                    });
                });
            }

            function get_user_nickname(user_id){
                return new Promise(function(resolve, reject){
                    $.get('http://localhost:5000/users/' + user_id + '/', function(data, status) {
                        console.log(data);
                        // example of getting a room from room_id
                        resolve(data['users-info']['nickname']);
                    });
                });
            }
        </script>
    </head>
    <body>
        <h1>Chirrup chat app</h1>
        <textarea id="chat" cols="80" rows="20"></textarea><br><br>
        <input id="text" size="80" placeholder="Enter your message here"><br><br>
        <a href="#" onclick="leave_room();">Leave this room</a>
    </body>
</html>
